# Upstream definition for MinIO
upstream minio_backend {
    server minio.minio-operator.svc.cluster.local;
    keepalive 32;
}

# Cache configuration
proxy_cache_path /var/cache/nginx/storybook levels=1:2
    keys_zone=storybook_cache:10m
    max_size=100m
    inactive=60m
    use_temp_path=off;

server {
    listen 80;
    server_name _;

    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # Health check endpoint
    location /health {
        return 200 'OK';
        add_header Content-Type text/plain;
    }

    # Proxy all requests to MinIO storybook bucket
    # Serve static assets directly (do not fallback to SPA index on missing files)
    location ~* \.(?:js|css|map|json|png|jpe?g|gif|svg|ico|woff2?|woff|ttf)$ {
        # Rewrite to storybook bucket path
        rewrite ^/(.*)$ /storybook/$1 break;

        proxy_pass http://minio_backend;
        proxy_http_version 1.1;
        proxy_set_header Host minio.minio-operator.svc.cluster.local;
        proxy_set_header Connection "";

        # Caching configuration
        proxy_cache storybook_cache;
        proxy_cache_valid 200 60m;
        proxy_cache_valid 404 1m;
        add_header X-Cache-Status $upstream_cache_status;

        # Security headers
        proxy_hide_header x-amz-request-id;
        proxy_hide_header x-amz-id-2;

        # Do not intercept errors so the client receives correct MIME and status
        proxy_intercept_errors off;
    }

    location / {
        # Rewrite to storybook bucket path
        rewrite ^/(.*)$ /storybook/$1 break;

        proxy_pass http://minio_backend;
        proxy_http_version 1.1;
        proxy_set_header Host minio.minio-operator.svc.cluster.local;
        proxy_set_header Connection "";

        # Caching configuration
        proxy_cache storybook_cache;
        proxy_cache_valid 200 60m;
        proxy_cache_valid 404 1m;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        add_header X-Cache-Status $upstream_cache_status;

        # Security headers
        proxy_hide_header x-amz-request-id;
        proxy_hide_header x-amz-id-2;

        # Default index (fall back to SPA index when object listing is denied or not found)
        proxy_intercept_errors on;
        error_page 403 404 = @index;
    }

    # Fallback to index.html for SPA routing
    location @index {
        rewrite ^/(.*)$ /storybook/index.html break;
        proxy_pass http://minio_backend;
        proxy_http_version 1.1;
        proxy_set_header Host minio.minio-operator.svc.cluster.local:9000;
        proxy_set_header Connection "";
    }
}
