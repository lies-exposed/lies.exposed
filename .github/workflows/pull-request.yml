name: Pull Request

on:
  pull_request:
    branches:
      - main

jobs:
  # Determine which services need CI based on changed files
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      # Per-service outputs
      admin: ${{ steps.filter.outputs.admin }}
      agent: ${{ steps.filter.outputs.agent }}
      ai-bot: ${{ steps.filter.outputs.ai-bot }}
      api: ${{ steps.filter.outputs.api }}
      packages: ${{ steps.filter.outputs.packages }}
      storybook: ${{ steps.filter.outputs.storybook }}
      web: ${{ steps.filter.outputs.web }}
      worker: ${{ steps.filter.outputs.worker }}
      root: ${{ steps.filter.outputs.root }}
      needs-install: ${{ steps.filter.outputs.needs-install }}
      # Aggregate outputs
      any-service: ${{ steps.filter.outputs.any-service }}
      any-code: ${{ steps.filter.outputs.any-code }}
    steps:
      - uses: actions/checkout@v6

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            needs-install:
              - "**/package.json"
              - "pnpm-lock.yaml"
              - "pnpm-workspace.yaml"
            admin:
              - ".github/workflows/**"
              - "packages/@liexp/core/src/**"
              - "packages/@liexp/io/src/**"
              - "packages/@liexp/shared/src/**"
              - "packages/@liexp/ui/src/**"
              - "services/admin/**"
            agent:
              - ".github/workflows/**"
              - "packages/@liexp/core/src/**"
              - "packages/@liexp/io/src/**"
              - "packages/@liexp/shared/src/**"
              - "packages/@liexp/backend/src/**"
              - "services/agent/**"
            ai-bot:
              - ".github/workflows/**"
              - "packages/@liexp/core/src/**"
              - "packages/@liexp/io/src/**"
              - "packages/@liexp/shared/src/**"
              - "packages/@liexp/backend/src/**"
              - "services/ai-bot/**"
            api:
              - ".github/workflows/**"
              - "packages/@liexp/core/**"
              - "packages/@liexp/io/src/**"
              - "packages/@liexp/shared/**"
              - "packages/@liexp/backend/**"
              - "services/api/**"
            packages:
              - ".github/workflows/**"
              - "packages/**"
            storybook:
              - ".github/workflows/**"
              - "packages/@liexp/**/src/**"
              - "services/storybook/**"
            web:
              - ".github/workflows/**"
              - "packages/@liexp/core/src/**"
              - "packages/@liexp/io/src/**"
              - "packages/@liexp/shared/src/**"
              - "packages/@liexp/ui/src/**"
              - "services/web/**"
            worker:
              - ".github/workflows/**"
              - "packages/@liexp/core/src/**"
              - "packages/@liexp/io/src/**"
              - "packages/@liexp/shared/src/**"
              - "packages/@liexp/backend/src/**"
              - "services/worker/**"
            root:
              - ".github/workflows/**"
              - "knip.json"
              - "package.json"
              - "pnpm-lock.yaml"
            # Aggregate filters
            any-service:
              - "services/**"
            any-code:
              - "packages/**"
              - "services/**"
              - ".github/workflows/**"

  # Install dependencies and build packages (shared cache for all jobs)
  install:
    needs: detect-changes
    if: needs.detect-changes.outputs.needs-install == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: ./.github/actions/install-deps
        with:
          hash: ${{ hashFiles('**/pnpm-lock.yaml') }}

      - uses: ./.github/actions/build-packages

  # CI job - lint, build, spec tests, and e2e tests (with conditional DB services)
  ci:
    needs: [detect-changes, install]
    if: |
      always() &&
      (needs.install.result == 'success' || needs.install.result == 'skipped')
    runs-on: ubuntu-latest

    # Conditional services - only start when matrix.needs_db is true
    services:
      redis:
        image: ${{ matrix.needs_db && 'redis:7' || '' }}
        ports:
          - 6379:6379
      pg-db-test:
        image: ${{ matrix.needs_db && 'postgres:17' || '' }}
        env:
          POSTGRES_USER: liexp
          POSTGRES_PASSWORD: liexp-password
          POSTGRES_DB: liexp_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 8432:5432

    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        include:
          - service: admin
            enabled: ${{ needs.detect-changes.outputs.admin == 'true' }}
            lint_command: pnpm admin lint
            build_command: pnpm admin build
            app_command: pnpm admin build:app
            spec_command: pnpm admin test
          - service: agent
            enabled: ${{ needs.detect-changes.outputs.agent == 'true' }}
            lint_command: pnpm agent lint
            build_command: pnpm agent build
            spec_command: pnpm agent test
          - service: ai-bot
            enabled: ${{ needs.detect-changes.outputs.ai-bot == 'true' }}
            lint_command: pnpm ai-bot lint
            build_command: pnpm ai-bot build
            spec_command: pnpm ai-bot test
          - service: api
            enabled: ${{ needs.detect-changes.outputs.api == 'true' }}
            lint_command: pnpm api lint
            build_command: pnpm api build
            spec_command: pnpm api test:spec
            e2e_command: pnpm api test:e2e
            migration_command: pnpm api migration:run
            dotenv_path: "./.env.test"
            needs_db: true
          - service: packages
            enabled: ${{ needs.detect-changes.outputs.packages == 'true' }}
            lint_command: |
              pnpm core lint
              pnpm io lint
              pnpm shared lint
              pnpm test lint
              pnpm backend lint
              pnpm ui lint
            spec_command: |
              pnpm core test
              pnpm io test
              pnpm shared test
              pnpm test test
              pnpm backend test
              pnpm ui test
          - service: storybook
            enabled: ${{ needs.detect-changes.outputs.storybook == 'true' }}
            lint_command: pnpm storybook lint
            build_command: pnpm storybook typecheck
            app_command: pnpm storybook build:app
            spec_command: pnpm storybook test
          - service: web
            enabled: ${{ needs.detect-changes.outputs.web == 'true' }}
            lint_command: pnpm web lint
            build_command: pnpm web build
            app_command: pnpm web build:app-server
            spec_command: pnpm web test
          - service: worker
            enabled: ${{ needs.detect-changes.outputs.worker == 'true' }}
            lint_command: pnpm worker lint
            build_command: pnpm worker build
            spec_command: pnpm worker test
            e2e_command: pnpm worker test:e2e
            dotenv_path: "./.env.test"
            needs_db: true

    name: CI ${{ matrix.service }}

    steps:
      - uses: actions/checkout@v6
        if: ${{ matrix.enabled }}

      - uses: ./.github/actions/setup-workspace
        if: ${{ matrix.enabled }}
        with:
          hash: ${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Lint ${{ matrix.service }}
        if: ${{ matrix.enabled && matrix.lint_command }}
        run: ${{ matrix.lint_command }}

      - name: Build ${{ matrix.service }}
        if: ${{ matrix.enabled && matrix.build_command }}
        uses: ./.github/actions/build-service
        with:
          service: ${{ matrix.service }}
          build_command: ${{ matrix.build_command }}

      - name: Build ${{ matrix.service }} app
        if: ${{ matrix.enabled && matrix.app_command }}
        env:
          DOTENV_CONFIG_PATH: "./.env"
        run: ${{ matrix.app_command }}

      - name: Test ${{ matrix.service }} (spec)
        if: ${{ matrix.enabled && matrix.spec_command }}
        uses: ./.github/actions/test-service
        with:
          service: ${{ matrix.service }}
          spec_command: ${{ matrix.spec_command }}
          dotenv_path: ${{ matrix.dotenv_path || '.env' }}

      - name: Run migrations
        if: ${{ matrix.enabled && matrix.migration_command }}
        env:
          DOTENV_CONFIG_PATH: ${{ matrix.dotenv_path || '.env' }}
        run: ${{ matrix.migration_command }}

      - name: Test ${{ matrix.service }} (e2e)
        if: ${{ matrix.enabled && matrix.e2e_command }}
        uses: ./.github/actions/test-service
        with:
          service: ${{ matrix.service }}
          e2e_command: ${{ matrix.e2e_command }}
          dotenv_path: ${{ matrix.dotenv_path || '.env' }}

  # Knip report (for any code changes)
  knip-report:
    needs: [detect-changes, install]
    if: |
      always() &&
      (needs.install.result == 'success' || needs.install.result == 'skipped') &&
      needs.detect-changes.outputs.any-code == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: ./.github/actions/setup-workspace
        with:
          hash: ${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Post the knip results
        run: pnpm knip
