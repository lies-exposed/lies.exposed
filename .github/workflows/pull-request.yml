name: Pull Request

on:
  pull_request:
    branches:
      - daily
      - release/alpha
      - master
    paths:
      - ".github/workflows/**"
      - "packages/@liexp/**"
      - "services/**"

jobs:
  # First, determine which services need to be tested based on changed files
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      admin-web: ${{ steps.filter.outputs.admin-web }}
      agent: ${{ steps.filter.outputs.agent }}
      ai-bot: ${{ steps.filter.outputs.ai-bot }}
      api: ${{ steps.filter.outputs.api }}
      packages: ${{ steps.filter.outputs.packages }}
      storybook: ${{ steps.filter.outputs.storybook }}
      web: ${{ steps.filter.outputs.web }}
      worker: ${{ steps.filter.outputs.worker }}
      root: ${{ steps.filter.outputs.root }}
      needs-install: ${{ steps.filter.outputs.needs-install }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            needs-install:
              - "**/package.json"
              - "pnpm-lock.yaml"
              - "pnpm-workspace.yaml"
            admin-web:
              - ".github/workflows/**"
              - "packages/@liexp/core/src/**"
              - "packages/@liexp/shared/src/**"
              - "packages/@liexp/ui/src/**"
              - "services/admin-web/**"
            agent:
              - ".github/workflows/**"
              - "packages/@liexp/core/src/**"
              - "packages/@liexp/shared/src/**"
              - "packages/@liexp/backend/src/**"
              - "services/agent/**"
            ai-bot:
              - ".github/workflows/**"
              - "packages/@liexp/core/src/**"
              - "packages/@liexp/shared/src/**"
              - "packages/@liexp/backend/src/**"
              - "services/ai-bot/**"
            api:
              - ".github/workflows/**"
              - "packages/@liexp/core/**"
              - "packages/@liexp/shared/**"
              - "packages/@liexp/backend/**"
              - "services/api/**"
            packages:
              - ".github/workflows/**"
              - "packages/**"
            storybook:
              - ".github/workflows/**"
              - "packages/@liexp/**/src/**"
              - "services/storybook/**"
            web:
              - ".github/workflows/**"
              - "packages/@liexp/core/src/**"
              - "packages/@liexp/shared/src/**"
              - "packages/@liexp/ui/src/**"
              - "services/web/**"
            worker:
              - ".github/workflows/**"
              - "packages/@liexp/core/src/**"
              - "packages/@liexp/shared/src/**"
              - "packages/@liexp/backend/src/**"
              - "services/worker/**"
            root:
              - ".github/workflows/**"
              - "knip.json"
              - "package.json"
              - "pnpm-lock.yaml"

  # Install dependencies once (populates cache for all other jobs)
  # Only runs if dependencies changed, otherwise jobs rely on existing cache
  install:
    needs: detect-changes
    if: needs.detect-changes.outputs.needs-install == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/install-deps
        with:
          hash: ${{ hashFiles('**/pnpm-lock.yaml') }}

      - uses: ./.github/actions/build-packages
        with:
          hash: ${{ github.sha }}

  # Combined CI job for lint, build, test, and docker
  ci:
    needs: [detect-changes, install]
    if: |
      always() &&
      (needs.install.result == 'success' || needs.install.result == 'skipped')
    runs-on: ubuntu-latest
    # Postgres and Redis services (only used by API tests)
    services:
      redis:
        image: redis:7
        ports:
          - 6379:6379
      pg-db-test:
        image: postgres:17
        env:
          POSTGRES_USER: liexp
          POSTGRES_PASSWORD: liexp-password
          POSTGRES_DB: liexp_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 8432:5432
    
    strategy:
      fail-fast: true
      max-parallel: 3
      matrix:
        include:
          - service: admin-web
            enabled: ${{ needs.detect-changes.outputs.admin-web == 'true' }}
            lint_command: pnpm admin-web lint
            build_command: pnpm admin-web build
            app_command: pnpm admin-web build:app
            has_app_build: true
            build_cache_key: admin-web-build
            test_command: pnpm admin-web test
            docker_enabled: ${{ github.base_ref == 'release/alpha' }}
            dockerfile: adminWeb.Dockerfile
            docker_image: liexp-admin-web
          - service: agent
            enabled: ${{ needs.detect-changes.outputs.agent == 'true' }}
            lint_command: pnpm agent lint
            build_command: pnpm agent build
            build_cache_key: agent-build
            test_command: pnpm agent test
            docker_enabled: ${{ github.base_ref == 'release/alpha' }}
            dockerfile: agent.Dockerfile
            docker_image: liexp-agent
          - service: ai-bot
            enabled: ${{ needs.detect-changes.outputs.ai-bot == 'true' }}
            lint_command: pnpm ai-bot lint
            build_command: pnpm ai-bot build
            build_cache_key: ai-bot-build
            test_command: pnpm ai-bot test
            docker_enabled: ${{ github.base_ref == 'release/alpha' }}
            dockerfile: ai-bot.Dockerfile
            docker_image: liexp-ai-bot
          - service: api
            enabled: ${{ needs.detect-changes.outputs.api == 'true' }}
            lint_command: pnpm api lint
            build_command: pnpm api build
            build_cache_key: api-build
            test_command: pnpm api test
            test_env_dotenv: "./.env.test"
            needs_db_services: true
            docker_enabled: ${{ github.base_ref == 'release/alpha' }}
            dockerfile: api.Dockerfile
            docker_image: liexp-api
          - service: packages
            enabled: ${{ needs.detect-changes.outputs.packages == 'true' }}
            lint_command: |
              pnpm core lint
              pnpm shared lint
              pnpm test lint
              pnpm backend lint
              pnpm ui lint
            test_command: |
              pnpm core test
              pnpm shared test
              pnpm test test
              pnpm backend test
              pnpm ui test
            test_env_debug: "-@liexp*"
          - service: storybook
            enabled: ${{ needs.detect-changes.outputs.storybook == 'true' }}
            lint_command: pnpm storybook lint
            build_command: pnpm storybook typecheck
            app_command: pnpm storybook build:app
            has_app_build: true
            build_cache_key: storybook-build
            test_command: pnpm storybook test
          - service: web
            enabled: ${{ needs.detect-changes.outputs.web == 'true' }}
            lint_command: pnpm web lint
            build_command: pnpm web build
            app_command: pnpm web build:app-server
            has_app_build: true
            build_cache_key: web-build
            test_command: pnpm web test
            docker_enabled: ${{ github.base_ref == 'release/alpha' }}
            dockerfile: web.Dockerfile
            docker_image: liexp-web
          - service: worker
            enabled: ${{ needs.detect-changes.outputs.worker == 'true' }}
            lint_command: pnpm worker lint
            build_command: pnpm worker build
            build_cache_key: worker-build
            test_command: pnpm worker test
            docker_enabled: ${{ github.base_ref == 'release/alpha' }}
            dockerfile: worker.Dockerfile
            docker_image: liexp-worker

    name: CI ${{ matrix.service }}
    
    steps:
      - uses: actions/checkout@v4
        if: ${{ matrix.enabled }}

      - uses: ./.github/actions/setup-workspace
        if: ${{ matrix.enabled }}
        with:
          hash: ${{ hashFiles('**/pnpm-lock.yaml') }}
          build_hash: ${{ github.sha }}

      # Lint step
      - name: Lint ${{ matrix.service }}
        if: ${{ matrix.enabled && matrix.lint_command }}
        run: ${{ matrix.lint_command }}

      # Build cache setup
      - name: Setup build cache for ${{ matrix.service }}
        if: ${{ matrix.enabled && matrix.build_cache_key }}
        uses: actions/cache@v4
        with:
          path: services/**/build
          key: ${{ matrix.build_cache_key }}

      # Build step (for API, use build-api action for consistency)
      - name: Build API (with action)
        if: ${{ matrix.enabled && matrix.service == 'api' }}
        uses: ./.github/actions/build-api
        with:
          hash: ${{ github.sha }}

      - name: Build ${{ matrix.service }}
        if: ${{ matrix.enabled && matrix.build_command && matrix.service != 'api' }}
        run: ${{ matrix.build_command }}

      - name: Build ${{ matrix.service }} app
        if: ${{ matrix.enabled && matrix.has_app_build }}
        env:
          DOTENV_CONFIG_PATH: "./.env"
        run: ${{ matrix.app_command }}

      # Test step
      - name: Run tests for ${{ matrix.service }}
        if: ${{ matrix.enabled && matrix.test_command }}
        env:
          DOTENV_CONFIG_PATH: ${{ matrix.test_env_dotenv || '.env' }}
          DEBUG: ${{ matrix.test_env_debug || '-@liexp*' }}
        run: ${{ matrix.test_command }}

      # Docker build step (only for PRs targeting release/alpha)
      - name: Docker build ${{ matrix.service }}
        if: ${{ matrix.enabled && matrix.docker_enabled && matrix.dockerfile }}
        uses: ./.github/actions/docker-build-push
        with:
          dockerfile: ${{ matrix.dockerfile }}
          image_name: ${{ matrix.docker_image }}
          push: false
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

  # Knip report (only for root changes)
  knip-report:
    needs: [detect-changes, install]
    if: |
      always() &&
      (needs.install.result == 'success' || needs.install.result == 'skipped') &&
      needs.detect-changes.outputs.root == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup-workspace
        with:
          hash: ${{ hashFiles('**/pnpm-lock.yaml') }}
          build_hash: ${{ github.sha }}

      - name: Post the knip results
        run: pnpm knip
