name: Pull Request

on:
  pull_request:
    branches:
      - main

jobs:
  # Determine which services need CI based on changed files
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      admin: ${{ steps.filter.outputs.admin }}
      agent: ${{ steps.filter.outputs.agent }}
      ai-bot: ${{ steps.filter.outputs.ai-bot }}
      api: ${{ steps.filter.outputs.api }}
      packages: ${{ steps.filter.outputs.packages }}
      storybook: ${{ steps.filter.outputs.storybook }}
      web: ${{ steps.filter.outputs.web }}
      worker: ${{ steps.filter.outputs.worker }}
      root: ${{ steps.filter.outputs.root }}
      needs-install: ${{ steps.filter.outputs.needs-install }}
    steps:
      - uses: actions/checkout@v6

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            needs-install:
              - "**/package.json"
              - "pnpm-lock.yaml"
              - "pnpm-workspace.yaml"
            admin:
              - ".github/workflows/**"
              - "packages/@liexp/core/src/**"
              - "packages/@liexp/io/src/**"
              - "packages/@liexp/shared/src/**"
              - "packages/@liexp/ui/src/**"
              - "services/admin/**"
            agent:
              - ".github/workflows/**"
              - "packages/@liexp/core/src/**"
              - "packages/@liexp/io/src/**"
              - "packages/@liexp/shared/src/**"
              - "packages/@liexp/backend/src/**"
              - "services/agent/**"
            ai-bot:
              - ".github/workflows/**"
              - "packages/@liexp/core/src/**"
              - "packages/@liexp/io/src/**"
              - "packages/@liexp/shared/src/**"
              - "packages/@liexp/backend/src/**"
              - "services/ai-bot/**"
            api:
              - ".github/workflows/**"
              - "packages/@liexp/core/**"
              - "packages/@liexp/io/src/**"
              - "packages/@liexp/shared/**"
              - "packages/@liexp/backend/**"
              - "services/api/**"
            packages:
              - ".github/workflows/**"
              - "packages/**"
            storybook:
              - ".github/workflows/**"
              - "packages/@liexp/**/src/**"
              - "services/storybook/**"
            web:
              - ".github/workflows/**"
              - "packages/@liexp/core/src/**"
              - "packages/@liexp/io/src/**"
              - "packages/@liexp/shared/src/**"
              - "packages/@liexp/ui/src/**"
              - "services/web/**"
            worker:
              - ".github/workflows/**"
              - "packages/@liexp/core/src/**"
              - "packages/@liexp/io/src/**"
              - "packages/@liexp/shared/src/**"
              - "packages/@liexp/backend/src/**"
              - "services/worker/**"
            root:
              - ".github/workflows/**"
              - "knip.json"
              - "package.json"
              - "pnpm-lock.yaml"

  # Install dependencies and build packages (shared cache for all jobs)
  install:
    needs: detect-changes
    if: needs.detect-changes.outputs.needs-install == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: ./.github/actions/install-deps
        with:
          hash: ${{ hashFiles('**/pnpm-lock.yaml') }}

      - uses: ./.github/actions/build-packages

  # Lint jobs - run in parallel per service
  lint:
    needs: [detect-changes, install]
    if: |
      always() &&
      (needs.install.result == 'success' || needs.install.result == 'skipped')
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 8
      matrix:
        include:
          - service: admin
            enabled: ${{ needs.detect-changes.outputs.admin == 'true' }}
            command: pnpm admin lint
          - service: agent
            enabled: ${{ needs.detect-changes.outputs.agent == 'true' }}
            command: pnpm agent lint
          - service: ai-bot
            enabled: ${{ needs.detect-changes.outputs.ai-bot == 'true' }}
            command: pnpm ai-bot lint
          - service: api
            enabled: ${{ needs.detect-changes.outputs.api == 'true' }}
            command: pnpm api lint
          - service: packages-core
            enabled: ${{ needs.detect-changes.outputs.packages == 'true' }}
            command: pnpm core lint
          - service: packages-io
            enabled: ${{ needs.detect-changes.outputs.packages == 'true' }}
            command: pnpm io lint
          - service: packages-shared
            enabled: ${{ needs.detect-changes.outputs.packages == 'true' }}
            command: pnpm shared lint
          - service: packages-test
            enabled: ${{ needs.detect-changes.outputs.packages == 'true' }}
            command: pnpm test lint
          - service: packages-backend
            enabled: ${{ needs.detect-changes.outputs.packages == 'true' }}
            command: pnpm backend lint
          - service: packages-ui
            enabled: ${{ needs.detect-changes.outputs.packages == 'true' }}
            command: pnpm ui lint
          - service: storybook
            enabled: ${{ needs.detect-changes.outputs.storybook == 'true' }}
            command: pnpm storybook lint
          - service: web
            enabled: ${{ needs.detect-changes.outputs.web == 'true' }}
            command: pnpm web lint
          - service: worker
            enabled: ${{ needs.detect-changes.outputs.worker == 'true' }}
            command: pnpm worker lint

    name: Lint ${{ matrix.service }}

    steps:
      - uses: actions/checkout@v6
        if: ${{ matrix.enabled }}

      - uses: ./.github/actions/setup-workspace
        if: ${{ matrix.enabled }}
        with:
          hash: ${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Lint ${{ matrix.service }}
        if: ${{ matrix.enabled }}
        run: ${{ matrix.command }}

  # Build jobs - run in parallel per service (with content-based caching)
  build:
    needs: [detect-changes, install, lint]
    if: |
      always() &&
      (needs.install.result == 'success' || needs.install.result == 'skipped') &&
      (needs.lint.result == 'success' || needs.lint.result == 'skipped')
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 8
      matrix:
        include:
          - service: admin
            enabled: ${{ needs.detect-changes.outputs.admin == 'true' }}
            build_command: pnpm admin build
            app_command: pnpm admin build:app
          - service: agent
            enabled: ${{ needs.detect-changes.outputs.agent == 'true' }}
            build_command: pnpm agent build
          - service: ai-bot
            enabled: ${{ needs.detect-changes.outputs.ai-bot == 'true' }}
            build_command: pnpm ai-bot build
          - service: api
            enabled: ${{ needs.detect-changes.outputs.api == 'true' }}
            build_command: pnpm api build
          - service: storybook
            enabled: ${{ needs.detect-changes.outputs.storybook == 'true' }}
            build_command: pnpm storybook typecheck
            app_command: pnpm storybook build:app
          - service: web
            enabled: ${{ needs.detect-changes.outputs.web == 'true' }}
            build_command: pnpm web build
            app_command: pnpm web build:app-server
          - service: worker
            enabled: ${{ needs.detect-changes.outputs.worker == 'true' }}
            build_command: pnpm worker build

    name: Build ${{ matrix.service }}

    steps:
      - uses: actions/checkout@v6
        if: ${{ matrix.enabled }}

      - uses: ./.github/actions/setup-workspace
        if: ${{ matrix.enabled }}
        with:
          hash: ${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Build ${{ matrix.service }}
        if: ${{ matrix.enabled && matrix.build_command }}
        uses: ./.github/actions/build-service
        with:
          service: ${{ matrix.service }}
          build_command: ${{ matrix.build_command }}

      - name: Build ${{ matrix.service }} app
        if: ${{ matrix.enabled && matrix.app_command }}
        env:
          DOTENV_CONFIG_PATH: "./.env"
        run: ${{ matrix.app_command }}

  # Test jobs - run spec tests in parallel (no DB needed)
  test:
    needs: [detect-changes, install, build]
    if: |
      always() &&
      (needs.install.result == 'success' || needs.install.result == 'skipped') &&
      (needs.build.result == 'success' || needs.build.result == 'skipped')
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 8
      matrix:
        include:
          - service: admin
            enabled: ${{ needs.detect-changes.outputs.admin == 'true' }}
            spec_command: pnpm admin test
          - service: agent
            enabled: ${{ needs.detect-changes.outputs.agent == 'true' }}
            spec_command: pnpm agent test
          - service: ai-bot
            enabled: ${{ needs.detect-changes.outputs.ai-bot == 'true' }}
            spec_command: pnpm ai-bot test
          - service: api
            enabled: ${{ needs.detect-changes.outputs.api == 'true' }}
            spec_command: pnpm api test:spec
            dotenv_path: "./.env.test"
          - service: packages-core
            enabled: ${{ needs.detect-changes.outputs.packages == 'true' }}
            spec_command: pnpm core test
          - service: packages-io
            enabled: ${{ needs.detect-changes.outputs.packages == 'true' }}
            spec_command: pnpm io test
          - service: packages-shared
            enabled: ${{ needs.detect-changes.outputs.packages == 'true' }}
            spec_command: pnpm shared test
          - service: packages-test
            enabled: ${{ needs.detect-changes.outputs.packages == 'true' }}
            spec_command: pnpm test test
          - service: packages-backend
            enabled: ${{ needs.detect-changes.outputs.packages == 'true' }}
            spec_command: pnpm backend test
          - service: packages-ui
            enabled: ${{ needs.detect-changes.outputs.packages == 'true' }}
            spec_command: pnpm ui test
          - service: storybook
            enabled: ${{ needs.detect-changes.outputs.storybook == 'true' }}
            spec_command: pnpm storybook test
          - service: web
            enabled: ${{ needs.detect-changes.outputs.web == 'true' }}
            spec_command: pnpm web test
          - service: worker
            enabled: ${{ needs.detect-changes.outputs.worker == 'true' }}
            spec_command: pnpm worker test
            dotenv_path: "./.env.test"

    name: Test ${{ matrix.service }}

    steps:
      - uses: actions/checkout@v6
        if: ${{ matrix.enabled }}

      - uses: ./.github/actions/setup-workspace
        if: ${{ matrix.enabled }}
        with:
          hash: ${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Build ${{ matrix.service }}
        if: ${{ matrix.enabled && !startsWith(matrix.service, 'packages-') }}
        uses: ./.github/actions/build-service
        with:
          service: ${{ matrix.service }}
          build_command: pnpm ${{ matrix.service }} build

      - name: Test ${{ matrix.service }}
        if: ${{ matrix.enabled }}
        uses: ./.github/actions/test-service
        with:
          service: ${{ matrix.service }}
          spec_command: ${{ matrix.spec_command }}
          dotenv_path: ${{ matrix.dotenv_path || '.env' }}

  # E2E tests - separate job with DB services (only for API)
  test-e2e:
    needs: [detect-changes, install, build]
    if: |
      always() &&
      needs.detect-changes.outputs.api == 'true' &&
      (needs.install.result == 'success' || needs.install.result == 'skipped') &&
      (needs.build.result == 'success' || needs.build.result == 'skipped')
    runs-on: ubuntu-latest
    services:
      redis:
        image: redis:7
        ports:
          - 6379:6379
      pg-db-test:
        image: postgres:17
        env:
          POSTGRES_USER: liexp
          POSTGRES_PASSWORD: liexp-password
          POSTGRES_DB: liexp_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 8432:5432

    name: Test API (e2e)

    steps:
      - uses: actions/checkout@v6

      - uses: ./.github/actions/setup-workspace
        with:
          hash: ${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Build API
        uses: ./.github/actions/build-service
        with:
          service: api
          build_command: pnpm api build

      - name: Test API (e2e)
        uses: ./.github/actions/test-service
        with:
          service: api
          e2e_command: pnpm api test:e2e
          dotenv_path: "./.env.test"

  # Knip report (for package or service changes)
  knip-report:
    needs: [detect-changes, install]
    if: |
      always() &&
      (needs.install.result == 'success' || needs.install.result == 'skipped') &&
      (needs.detect-changes.outputs.packages == 'true' ||
       needs.detect-changes.outputs.admin == 'true' ||
       needs.detect-changes.outputs.agent == 'true' ||
       needs.detect-changes.outputs.ai-bot == 'true' ||
       needs.detect-changes.outputs.api == 'true' ||
       needs.detect-changes.outputs.storybook == 'true' ||
       needs.detect-changes.outputs.web == 'true' ||
       needs.detect-changes.outputs.worker == 'true' ||
       needs.detect-changes.outputs.root == 'true')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: ./.github/actions/setup-workspace
        with:
          hash: ${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Post the knip results
        run: pnpm knip
