name: Deploy Services

on:
  push:
    branches:
      - main
    paths:
      - ".github/workflows/**"
      - "packages/@liexp/core/**"
      - "packages/@liexp/shared/**"
      - "packages/@liexp/ui/**"
      - "packages/@liexp/backend/**"
      - "services/admin-web/**"
      - "services/agent/**"
      - "services/ai-bot/**"
      - "services/api/**"
      - "services/web/**"
      - "services/worker/**"

jobs:
  # Setup: Install deps and build (only needed for ai-bot)
  setup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/install-deps
        with:
          hash: ${{ hashFiles('**/pnpm-lock.yaml') }}

      - uses: ./.github/actions/build-packages
        with:
          hash: ${{ github.sha }}

      - name: Build ai-bot
        run: pnpm ai-bot build

      - name: Upload ai-bot build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ai-bot-build
          path: services/ai-bot/build/
          retention-days: 1

  # Build and push Docker images in parallel
  deploy:
    needs: [setup]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - service: admin-web
            enabled: true
            dockerfile: adminWeb.Dockerfile
            image_tag: ghcr.io/lies-exposed/liexp-admin-web:latest
          - service: agent
            enabled: true
            dockerfile: agent.Dockerfile
            image_tag: ghcr.io/lies-exposed/liexp-agent:latest
          - service: ai-bot
            enabled: true
            dockerfile: ai-bot.Dockerfile
            image_tag: ghcr.io/lies-exposed/liexp-ai-bot:latest
            needs_artifacts: true
          - service: api
            enabled: true
            dockerfile: api.Dockerfile
            image_tag: ghcr.io/lies-exposed/liexp-api:latest
          - service: web
            enabled: true
            dockerfile: web.Dockerfile
            image_tag: ghcr.io/lies-exposed/liexp-web:latest
          - service: worker
            enabled: true
            dockerfile: worker.Dockerfile
            image_tag: ghcr.io/lies-exposed/liexp-worker:latest

    name: Deploy ${{ matrix.service }}
    
    steps:
      - uses: actions/checkout@v4
        if: ${{ matrix.enabled }}

      # Download ai-bot build artifacts if needed
      - name: Download ai-bot build artifacts
        if: ${{ matrix.needs_artifacts && matrix.enabled }}
        uses: actions/download-artifact@v4
        with:
          name: ai-bot-build
          path: services/ai-bot/build/

      # Docker build and push
      - name: Log in to registry
        if: ${{ matrix.enabled }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.GHCR_IO_USERNAME }}
          password: ${{ secrets.GHCR_IO_TOKEN }}

      - name: Set up Docker Buildx
        if: ${{ matrix.enabled }}
        uses: docker/setup-buildx-action@v3

      - name: Build and push ${{ matrix.service }} image
        if: ${{ matrix.enabled }}
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./${{ matrix.dockerfile }}
          push: true
          tags: ${{ matrix.image_tag }}
        env:
          DOTENV_CONFIG_PATH: ${{ matrix.service == 'admin-web' && '.env.prod' || matrix.service == 'web' && '.env.prod' || null }}

