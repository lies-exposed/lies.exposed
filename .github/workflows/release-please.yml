name: Release Please

on:
  push:
    branches:
      - main
    paths:
      - 'services/**'
      - 'packages/**'
      - 'compose*.yml'
      - '.github/workflows/deploy.yml'
      - 'Dockerfile*'

permissions:
  contents: write
  pull-requests: write
  packages: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      releases_created: ${{ steps.release.outputs.releases_created }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

  # Setup: Install deps and build (only when release is created)
  setup:
    needs: [release-please]
    if: needs.release-please.outputs.releases_created
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/install-deps
        with:
          hash: ${{ hashFiles('**/pnpm-lock.yaml') }}

      - uses: ./.github/actions/build-packages
        with:
          hash: ${{ github.sha }}

      - name: Build ai-bot
        run: pnpm ai-bot build

      - name: Upload ai-bot build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ai-bot-build
          path: services/ai-bot/build/
          retention-days: 1

  # Build and push Docker images in parallel (only when release is created)
  deploy:
    needs: [release-please, setup]
    if: needs.release-please.outputs.releases_created
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - service: admin-web
            enabled: true
            dockerfile: adminWeb.Dockerfile
            image_tag: ghcr.io/lies-exposed/liexp-admin-web:latest
          - service: agent
            enabled: true
            dockerfile: agent.Dockerfile
            image_tag: ghcr.io/lies-exposed/liexp-agent:latest
          - service: ai-bot
            enabled: true
            dockerfile: ai-bot.Dockerfile
            image_tag: ghcr.io/lies-exposed/liexp-ai-bot:latest
            needs_artifacts: true
          - service: api
            enabled: true
            dockerfile: api.Dockerfile
            image_tag: ghcr.io/lies-exposed/liexp-api:latest
          - service: web
            enabled: true
            dockerfile: web.Dockerfile
            image_tag: ghcr.io/lies-exposed/liexp-web:latest
          - service: worker
            enabled: true
            dockerfile: worker.Dockerfile
            image_tag: ghcr.io/lies-exposed/liexp-worker:latest

    name: Deploy ${{ matrix.service }}

    steps:
      - uses: actions/checkout@v4
        if: ${{ matrix.enabled }}

      # Download ai-bot build artifacts if needed
      - name: Download ai-bot build artifacts
        if: ${{ matrix.needs_artifacts && matrix.enabled }}
        uses: actions/download-artifact@v4
        with:
          name: ai-bot-build
          path: services/ai-bot/build/

      # Docker build and push
      - name: Docker build ${{ matrix.service }}
        if: ${{ matrix.enabled && matrix.dockerfile }}
        uses: ./.github/actions/docker-build-push
        with:
          dockerfile: ${{ matrix.dockerfile }}
          image_name: ${{ matrix.image_tag }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          push: true
          build-args: |
            DOTENV_CONFIG_PATH=${{ matrix.service == 'admin-web' && '.env.prod' || matrix.service == 'web' && '.env.prod' || '.env' }}
