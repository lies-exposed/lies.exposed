name: Release Please

on:
  push:
    branches:
      - main
    paths:
      - "services/**"
      - "packages/**"
      - "package.json"
      - "pnpm-lock.yaml"
      - "compose*.yml"
      - ".github/workflows/deploy.yml"
      - "Dockerfile*"
      - "release-please-config.json"
      - ".release-please-manifest.json"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  packages: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      releases_created: ${{ steps.release.outputs.releases_created }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

  # Setup: Install deps and build (only when release is created)
  setup:
    needs: [release-please]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: ./.github/actions/install-deps
        with:
          hash: ${{ hashFiles('**/pnpm-lock.yaml') }}

      - uses: ./.github/actions/build-packages

      - name: Build ai-bot
        run: pnpm ai-bot build

      - name: Upload ai-bot build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: ai-bot-build
          path: services/ai-bot/build/
          retention-days: 1

  # Build and sync Storybook to MinIO (only when release is created)
  storybook:
    needs: [release-please, setup]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: ./.github/actions/install-deps
        with:
          hash: ${{ hashFiles('**/pnpm-lock.yaml') }}

      - uses: ./.github/actions/build-packages

      - name: Build Storybook
        run: |
          set -euo pipefail
          # Use production env for Storybook build (CI)
          cp -f services/storybook/.env.prod services/storybook/.env
          export VITE_NODE_ENV=production

          pnpm storybook build:app

      - name: Install MinIO Client
        if: needs.release-please.outputs.releases_created == 'true'
        run: |
          curl -O https://dl.min.io/client/mc/release/linux-amd64/mc
          chmod +x mc
          sudo mv mc /usr/local/bin/
          mc alias set lies-exposed-space \
            https://space.lies.exposed \
            ${{ secrets.MINIO_ACCESS_KEY }} \
            ${{ secrets.MINIO_SECRET_KEY }}
          mc mirror --overwrite --remove \
            services/storybook/build \
            lies-exposed-space/storybook

  # Build and push Docker images in parallel (only when release is created)
  deploy:
    needs: [release-please, setup]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - service: admin
            enabled: true
            dockerfile: admin.Dockerfile
            image_tag: ghcr.io/lies-exposed/liexp-admin:latest
          - service: agent
            enabled: true
            dockerfile: agent.Dockerfile
            image_tag: ghcr.io/lies-exposed/liexp-agent:latest
          - service: ai-bot
            enabled: true
            dockerfile: ai-bot.Dockerfile
            image_tag: ghcr.io/lies-exposed/liexp-ai-bot:latest
            needs_artifacts: true
          - service: api
            enabled: true
            dockerfile: api.Dockerfile
            image_tag: ghcr.io/lies-exposed/liexp-api:latest
          - service: web
            enabled: true
            dockerfile: web.Dockerfile
            image_tag: ghcr.io/lies-exposed/liexp-web:latest
          - service: worker
            enabled: true
            dockerfile: worker.Dockerfile
            image_tag: ghcr.io/lies-exposed/liexp-worker:latest

    name: Deploy ${{ matrix.service }}

    steps:
      - uses: actions/checkout@v6
        if: ${{ matrix.enabled }}

      - name: Get version from package.json
        if: ${{ matrix.enabled }}
        id: pkg-version
        run: echo "version=$(node -p 'require(\"./package.json\").version')" >> "$GITHUB_OUTPUT"

      # Download ai-bot build artifacts if needed
      - name: Download ai-bot build artifacts
        if: ${{ matrix.needs_artifacts && matrix.enabled }}
        uses: actions/download-artifact@v8
        with:
          name: ai-bot-build
          path: services/ai-bot/build/

      # Docker build and push
      - name: Docker build ${{ matrix.service }}
        if: ${{ matrix.enabled && matrix.dockerfile }}
        uses: ./.github/actions/docker-build-push
        with:
          dockerfile: ${{ matrix.dockerfile }}
          image_name: ${{ matrix.image_tag }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          push: ${{ needs.release-please.outputs.releases_created == 'true' }}
          build-args: |
            DOTENV_CONFIG_PATH=${{ matrix.service == 'admin' && '.env.prod' || matrix.service == 'web' && '.env.prod' || '.env' }}
            VITE_VERSION=${{ steps.pkg-version.outputs.version }}
            VITE_COMMIT_HASH=${{ github.sha }}
            VERSION=${{ steps.pkg-version.outputs.version }}
            COMMIT_HASH=${{ github.sha }}
